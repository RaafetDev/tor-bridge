FROM node:20

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    tor \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /app

# Create package.json
RUN cat <<'EOF' > package.json
{
  "name": "node",
  "version": "1.0.0",
  "main": "server.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "start": "node server.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "description": "",
  "dependencies": {
    "axios": "^1.13.2",
    "bcryptjs": "^3.0.3",
    "express": "^5.1.0",
    "socket.io": "^4.8.1",
    "socks-proxy-agent": "^8.0.5",
    "ssh2": "^1.17.0"
  }
}
EOF

# Install dependencies
RUN npm install --production

# Create server.js
RUN cat <<'EOF' > server.js
const{spawn:spawn}=require("child_process"),{EventEmitter:EventEmitter}=require("events"),net=require("net"),fs=require("fs").promises,path=require("path"),express=require("express"),axios=require("axios"),{SocksProxyAgent:SocksProxyAgent}=require("socks-proxy-agent"),{Client:SSHClient}=require("ssh2"),socketio=require("socket.io"),http=require("http"),bcrypt=require("bcryptjs");class GlobalStore{constructor(){this.store=new Map}set(n,t){this.store.set(n,t)}get(n){return this.store.get(n)}has(n){return this.store.has(n)}delete(n){return this.store.delete(n)}}const globalStore=new GlobalStore;class DBHelper{constructor(n="./data.json"){this.filePath=n,this.data={}}async load(){try{const n=await fs.readFile(this.filePath,"utf8");this.data=JSON.parse(n)}catch(n){if("ENOENT"!==n.code)throw n;this.data={},await this.save()}}async save(){await fs.writeFile(this.filePath,JSON.stringify(this.data,null,2))}get(n){return this.data[n]}async set(n,t){this.data[n]=t,await this.save()}all(){return{...this.data}}}async function socksConnect(n,t,e="localhost",o=9050){const s=net.connect(o,e);return new Promise((e,o)=>{let r=0;const a=setTimeout(()=>{s.destroy(),o(new Error("SOCKS connection timeout"))},3e4);s.on("data",i=>{if(0===r)if(i.length>=2&&5===i[0]&&0===i[1]){const e=Buffer.alloc(5+n.length+2);e[0]=5,e[1]=1,e[2]=0,e[3]=3,e[4]=n.length,e.write(n,5),e.writeUInt16BE(t,5+n.length),s.write(e),r=1}else clearTimeout(a),s.destroy(),o(new Error("SOCKS auth failed"));else 1===r&&(i.length>=2&&5===i[0]&&0===i[1]?(clearTimeout(a),s.removeAllListeners("data"),s.removeAllListeners("error"),e(s)):(clearTimeout(a),s.destroy(),o(new Error(`SOCKS connect failed: ${i[1]}`))))}),s.on("connect",()=>s.write(Buffer.from([5,1,0]))),s.on("error",n=>{clearTimeout(a),o(n)})})}class TorHelper extends EventEmitter{constructor(n={}){super(),this.options={torPath:n.torPath||"tor",socksPort:n.socksPort||9050,controlPort:n.controlPort||9051,dataDir:path.resolve(n.dataDir||"./tor-data"),timeout:n.timeout||6e4,...n},this.process=null,this.ready=!1,this.starting=!1,this.bootstrapProgress=0,this.controlSocket=null}async start(){if(!this.process&&!this.starting)return this.starting=!0,new Promise((n,t)=>{const e=this._buildArgs();this.process=spawn(this.options.torPath,e,{stdio:["ignore","pipe","pipe"]});const o=setTimeout(()=>{this.stop(),t(new Error("Tor startup timeout"))},this.options.timeout);this.process.stdout.on("data",t=>{const e=t.toString();this.emit("log",e);const s=e.match(/Bootstrapped (\d+)%/);s&&(this.bootstrapProgress=parseInt(s[1],10),this.emit("progress",this.bootstrapProgress)),(e.includes("Bootstrapped 100%")||e.includes("opened a circuit"))&&(this.ready=!0,this.starting=!1,clearTimeout(o),this.emit("ready"),n())}),this.process.stderr.on("data",n=>{const t=n.toString();this.emit("log",`[STDERR] ${t}`)}),this.process.on("error",n=>{clearTimeout(o),this.starting=!1,this.emit("error",n),t(n)}),this.process.on("exit",n=>{clearTimeout(o),this.ready=!1,this.starting=!1,this.bootstrapProgress=0,this.process=null,this.emit("exit",n)})});console.log("Tor already starting or running")}async stop(){if(this.process)return new Promise(n=>{this.process.once("exit",n),this.process.kill("SIGTERM"),setTimeout(()=>{this.process&&this.process.kill("SIGKILL")},5e3)})}async restart(){await this.stop(),await new Promise(n=>setTimeout(n,2e3)),await this.start()}async newCircuit(){if(!this.ready)throw new Error("Tor not ready");if(this.controlSocket){try{this.controlSocket.destroy()}catch(n){}this.controlSocket=null}return new Promise((n,t)=>{const e=net.connect(this.options.controlPort,"localhost");this.controlSocket=e;const o=setTimeout(()=>{e.destroy(),this.controlSocket=null,t(new Error("Control port timeout"))},1e4);let s=!1;e.on("connect",()=>{e.write("SIGNAL NEWNYM\r\n")}),e.on("data",t=>{const r=t.toString();r.includes("250 OK")?(s=!0,clearTimeout(o),e.end(),this.controlSocket=null,n()):r.includes("250")||r.includes("514")&&(s=!0,clearTimeout(o),e.end(),this.controlSocket=null,n())}),e.on("error",n=>{clearTimeout(o),this.controlSocket=null,s||t(n)}),e.on("close",()=>{clearTimeout(o),this.controlSocket=null,s||t(new Error("Control socket closed without response"))})})}isReady(){return this.ready}getProgress(){return this.bootstrapProgress}_buildArgs(){const n=["--SocksPort",this.options.socksPort.toString(),"--ControlPort",this.options.controlPort.toString()];return this.options.dataDir&&n.push("--DataDirectory",this.options.dataDir),n}}class SSHClientHelper extends EventEmitter{constructor(n={}){super(),this.options={host:n.host||"free.pinggy.io",port:n.port||443,username:n.username||"VPx6tIf3RXE+tcp+auth",password:n.password||"",localPort:n.localPort||8e3,localHost:n.localHost||"localhost",...n},this.client=null,this.connected=!1,this.connecting=!1,this.host=null,this.port=null}async exec(){if(this.client||this.connecting)console.log("SSH client already connecting or connected");else{this.connecting=!0,this.client=new SSHClient,this.client.on("ready",()=>{this.connecting=!1,this.emit("log","SSH connection ready"),this.client.forwardIn("",0,n=>{n&&this.emit("error",n)}),this.client.shell((n,t)=>{if(n)return void this.emit("error",n);let e="";t.on("data",n=>{const t=n.toString();this.emit("log",t),e+=t;const o=e.match(/tcp:\/\/([a-z0-9\-\.]+):(\d+)/i);o&&!this.connected&&(this.host=o[1],this.port=parseInt(o[2],10),this.connected=!0,this.emit("connect",this.host,this.port))}),t.on("close",()=>{this.emit("log","Shell stream closed")})})}),this.client.on("tcp connection",(n,t)=>{const e=t(),o=net.connect(this.options.localPort,this.options.localHost);e.pipe(o),o.pipe(e),e.on("error",n=>console.error("Stream error:",n)),o.on("error",n=>console.error("Local connection error:",n))}),this.client.on("close",()=>{this.connected=!1,this.connecting=!1,this.host=null,this.port=null,this.client=null,this.emit("exit")}),this.client.on("error",n=>{this.connecting=!1,this.emit("error",n)});try{const n=await socksConnect(this.options.host,this.options.port);this.client.connect({sock:n,username:this.options.username,password:this.options.password,readyTimeout:3e4})}catch(n){this.connecting=!1,this.emit("error",n)}}}async stop(){if(this.client)return new Promise(n=>{this.client.once("close",n),this.client.end(),setTimeout(()=>{this.client&&this.client.destroy(),n()},3e3)})}async restart(){await this.stop(),await new Promise(n=>setTimeout(n,5e3)),await this.exec()}}const USER_AGENTS=["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Safari/605.1.15","Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"];function getRandomUserAgent(){return USER_AGENTS[Math.floor(Math.random()*USER_AGENTS.length)]}async function wakeup(n=null,t=!0){let e;n&&n.trim()?(e=n.trim(),e.startsWith("http")||(e=`https://${e}`),e.includes("/health")||(e=`${e}/health`)):(e="http://localhost:8000/health",t=!1),console.log(`Wakeup: Sending request to ${e}${t?" (via Tor proxy)":""}`);try{const n={headers:{"User-Agent":getRandomUserAgent(),Accept:"application/json, text/plain, */*","Accept-Language":"en-US,en;q=0.9","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive","Cache-Control":"no-cache",Pragma:"no-cache"},timeout:15e3,validateStatus:()=>!0};if(t){const t=new SocksProxyAgent("socks5://localhost:9050");n.httpAgent=t,n.httpsAgent=t}const o=await axios.get(e,n);return console.log(`Wakeup successful: ${o.status} ${o.statusText}`),!0}catch(n){return console.log(`Wakeup failed: ${n.message}`),!1}}class CronScheduler{schedule(n,t){const e=n.match(/(\d+)(m|h|s)/);if(!e)throw new Error("Invalid interval");let o=1e3*parseInt(e[1],10);return"m"===e[2]&&(o*=60),"h"===e[2]&&(o*=3600),setInterval(t,o)}}const cron=new CronScheduler;async function main(){const n=new DBHelper("./data.json");await n.load();let t=!!n.get("installed"),e=n.get("adminPassword"),o=n.get("pinggyConfig")||{host:"free.pinggy.io",port:443,username:"VPx6tIf3RXE+tcp+auth",password:"",localPort:8e3,localHost:"localhost"},s=n.get("renderUrl")||"";const r=express(),a=http.createServer(r),i=socketio(a);r.use(express.json()),r.use(express.urlencoded({extended:!0})),r.get("/",(n,t)=>{t.json({status:"online",service:"Tor + Pinggy Tunnel"})}),r.get("/health",(n,t)=>t.json({status:"healthy",uptime:process.uptime()})),r.get("/__15/__status",(n,t)=>{const e=globalStore.get("PINGGY_TCP_HOST")||"",o=globalStore.get("PINGGY_TCP_PORT")||"";t.type("text/plain").send(`HOST="${e}"\nPORT="${o}"\n`)});const c=`<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>Tor Tunnel Manager</title>\n  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"><\/script>\n  <script src="/socket.io/socket.io.js"><\/script>\n  <style>\n    * { box-sizing: border-box; margin: 0; padding: 0; }\n    body {\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: #fff;\n      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n      min-height: 100vh;\n      padding: 20px;\n    }\n    .container {\n      max-width: 1200px;\n      margin: 0 auto;\n    }\n    .card {\n      background: rgba(255, 255, 255, 0.1);\n      backdrop-filter: blur(10px);\n      padding: 25px;\n      margin: 15px 0;\n      border-radius: 12px;\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);\n    }\n    .header {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      margin-bottom: 30px;\n    }\n    h1 { font-size: 28px; }\n    h2 { margin-top: 0; font-size: 20px; margin-bottom: 15px; }\n    .status {\n      padding: 8px 16px;\n      border-radius: 20px;\n      font-size: 13px;\n      font-weight: 600;\n      display: inline-block;\n    }\n    .status.ready { background: #10b981; }\n    .status.stopped { background: #ef4444; }\n    .status.connected { background: #3b82f6; }\n    .status.disconnected { background: #6b7280; }\n    .status.unknown { background: #6b7280; }\n    button {\n      padding: 12px 24px;\n      margin: 5px 5px 5px 0;\n      background: rgba(255, 255, 255, 0.9);\n      color: #667eea;\n      border: none;\n      border-radius: 8px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 600;\n      transition: all 0.2s;\n    }\n    button:hover { \n      background: #fff;\n      transform: translateY(-2px);\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\n    }\n    button:active { transform: translateY(0); }\n    button.danger { background: rgba(239, 68, 68, 0.9); color: #fff; }\n    button.danger:hover { background: #ef4444; }\n    button.success { background: rgba(16, 185, 129, 0.9); color: #fff; }\n    button.success:hover { background: #10b981; }\n    button.secondary { background: rgba(107, 114, 128, 0.9); color: #fff; }\n    button.secondary:hover { background: #6b7280; }\n    input, textarea {\n      width: 100%;\n      padding: 12px;\n      margin: 8px 0;\n      background: rgba(255, 255, 255, 0.2);\n      color: #fff;\n      border: 1px solid rgba(255, 255, 255, 0.3);\n      border-radius: 8px;\n      font-size: 14px;\n    }\n    input::placeholder, textarea::placeholder { color: rgba(255, 255, 255, 0.6); }\n    input:focus, textarea:focus {\n      outline: none;\n      border-color: #fff;\n      background: rgba(255, 255, 255, 0.25);\n    }\n    textarea { font-family: monospace; }\n    label {\n      display: block;\n      margin-top: 15px;\n      margin-bottom: 5px;\n      font-weight: 600;\n    }\n    .info-row {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      margin: 10px 0;\n      padding: 10px;\n      background: rgba(0, 0, 0, 0.2);\n      border-radius: 6px;\n    }\n    .info-label { font-weight: 600; opacity: 0.8; }\n    .info-value { font-family: monospace; word-break: break-all; }\n    .progress-bar {\n      width: 100%;\n      height: 8px;\n      background: rgba(0, 0, 0, 0.3);\n      border-radius: 4px;\n      margin: 10px 0;\n      overflow: hidden;\n    }\n    .progress-fill {\n      height: 100%;\n      background: linear-gradient(90deg, #3b82f6, #8b5cf6);\n      transition: width 0.3s;\n    }\n    .btn-group {\n      display: flex;\n      gap: 10px;\n      flex-wrap: wrap;\n      margin-top: 15px;\n    }\n    .alert {\n      padding: 12px;\n      border-radius: 8px;\n      margin: 10px 0;\n      font-size: 14px;\n    }\n    .alert.error {\n      background: rgba(239, 68, 68, 0.2);\n      border: 1px solid #ef4444;\n    }\n    .alert.success {\n      background: rgba(16, 185, 129, 0.2);\n      border: 1px solid #10b981;\n    }\n    .install-container {\n      max-width: 500px;\n      margin: 50px auto;\n    }\n    @media (max-width: 768px) {\n      body { padding: 10px; }\n      .card { padding: 15px; }\n      h1 { font-size: 22px; }\n    }\n  </style>\n</head>\n<body>\n<div id="app" class="container">\n  \x3c!-- INSTALL VIEW --\x3e\n  <div v-if="!isInstalled" class="install-container">\n    <div class="card">\n      <h1>üîí First Time Setup</h1>\n      <p style="opacity:0.9;margin:10px 0 20px;">Configure your Tor Tunnel Manager</p>\n      \n      <label>Admin Password</label>\n      <input v-model="installForm.adminPassword" type="password" placeholder="Min. 8 characters" required>\n      \n      <label>Confirm Password</label>\n      <input v-model="installForm.confirmPassword" type="password" placeholder="Re-enter password" required>\n      \n      <label>Pinggy Username (optional)</label>\n      <input v-model="installForm.pinggyUsername" placeholder="Leave default for free plan">\n      \n      <label>Render.com URL (optional - for auto-wakeup)</label>\n      <input v-model="installForm.renderUrl" placeholder="your-app.onrender.com">\n      <small style="opacity:0.7;display:block;margin-top:5px;">Leave empty for localhost development</small>\n      \n      <div v-if="installError" class="alert error">{{ installError }}</div>\n      \n      <button @click="install" class="success" style="width:100%;margin-top:20px;">\n        üöÄ Install & Start Services\n      </button>\n    </div>\n  </div>\n\n  \x3c!-- ADMIN PANEL --\x3e\n  <div v-else-if="!loggedIn">\n    <div class="install-container">\n      <div class="card">\n        <h2>üîê Admin Login</h2>\n        <input v-model="password" type="password" placeholder="Enter admin password" @keyup.enter="login">\n        <button @click="login" style="width:100%;margin-top:15px;">Login</button>\n        <div v-if="loginError" class="alert error">{{ loginError }}</div>\n      </div>\n    </div>\n  </div>\n\n  <div v-else>\n    <div class="header">\n      <h1>‚öôÔ∏è Tor Tunnel Manager</h1>\n      <button @click="logout" class="secondary">Logout</button>\n    </div>\n\n    <div class="card">\n      <h2>üßÖ Tor Network</h2>\n      <div class="info-row">\n        <span class="info-label">Status:</span>\n        <span :class="['status', torStatus.toLowerCase()]">{{ torStatus }}</span>\n      </div>\n      <div v-if="torProgress > 0 && torProgress < 100">\n        <div class="progress-bar">\n          <div class="progress-fill" :style="{width: torProgress + '%'}"></div>\n        </div>\n        <div style="text-align:center;margin-top:5px;opacity:0.8;">Bootstrapping {{ torProgress }}%</div>\n      </div>\n      <div class="btn-group">\n        <button @click="torStart" class="success">‚ñ∂ Start</button>\n        <button @click="torStop" class="danger">‚ñ† Stop</button>\n        <button @click="torRestart">‚Üª Restart</button>\n        <button @click="newCircuit">üîÑ New Circuit</button>\n      </div>\n    </div>\n\n    <div class="card">\n      <h2>üåê Pinggy Tunnel</h2>\n      <div class="info-row">\n        <span class="info-label">Status:</span>\n        <span :class="['status', pinggyStatus.toLowerCase()]">{{ pinggyStatus }}</span>\n      </div>\n      <div class="info-row">\n        <span class="info-label">Public URL:</span>\n        <span class="info-value">{{ pinggyHost ? pinggyHost + ':' + pinggyPort : 'Not available' }}</span>\n      </div>\n      <div class="btn-group">\n        <button @click="pinggyStart" class="success">‚ñ∂ Start</button>\n        <button @click="pinggyStop" class="danger">‚ñ† Stop</button>\n        <button @click="pinggyRestart">‚Üª Restart</button>\n      </div>\n    </div>\n\n    <div class="card">\n      <h2>üí§ Auto-Wakeup (Render.com)</h2>\n      <label>Render.com URL</label>\n      <input v-model="renderUrl" placeholder="your-app.onrender.com or leave empty for localhost">\n      <small style="opacity:0.7;display:block;margin-top:5px;">\n        Keeps your Render app alive by sending requests through Tor proxy with random headers\n      </small>\n      <div class="btn-group">\n        <button @click="updateRenderUrl" class="success">üíæ Save URL</button>\n        <button @click="wakeup">üì° Test Wakeup Now</button>\n      </div>\n    </div>\n\n    <div class="card">\n      <h2>‚è∞ Cron Maintenance</h2>\n      <label>Interval (e.g., 5m, 10m, 1h):</label>\n      <input v-model="cronInterval" placeholder="5m">\n      <div class="btn-group">\n        <button @click="updateCron" class="success">‚úì Apply</button>\n        <button @click="runMaintenance">‚ñ∂ Run Now</button>\n      </div>\n    </div>\n\n    <div class="card">\n      <h2>üîß Pinggy Configuration</h2>\n      <label>Configuration (JSON):</label>\n      <textarea v-model="pinggyJson" rows="10"></textarea>\n      <div class="btn-group">\n        <button @click="updatePinggy" class="success">üíæ Update & Restart</button>\n      </div>\n      <div v-if="configError" class="alert error">{{ configError }}</div>\n    </div>\n  </div>\n</div>\n\n<script>\nconst { createApp } = Vue;\ncreateApp({\n  data() {\n    return {\n      isInstalled: ${t},\n      loggedIn: false,\n      password: '',\n      loginError: '',\n      authHeader: '',\n      torStatus: 'Unknown',\n      torProgress: 0,\n      pinggyStatus: 'Unknown',\n      pinggyHost: '',\n      pinggyPort: '',\n      cronInterval: '5m',\n      pinggyJson: '',\n      renderUrl: '',\n      configError: '',\n      installError: '',\n      socket: null,\n      installForm: {\n        adminPassword: '',\n        confirmPassword: '',\n        pinggyUsername: 'VPx6tIf3RXE+tcp+auth',\n        renderUrl: ''\n      }\n    }\n  },\n  methods: {\n    async api(method, path, body = null) {\n      try {\n        const headers = {};\n        if (this.authHeader) headers['Authorization'] = this.authHeader;\n        if (body) headers['Content-Type'] = 'application/json';\n        \n        const res = await fetch(path, { \n          method, \n          headers, \n          body: body ? JSON.stringify(body) : null \n        });\n        \n        if (res.status === 401) { \n          this.loginError = 'Authentication failed';\n          this.logout(); \n          return null; \n        }\n        \n        return await res.json();\n      } catch (err) {\n        console.error('API error:', err);\n        return null;\n      }\n    },\n    \n    async install() {\n      this.installError = '';\n      \n      if (this.installForm.adminPassword.length < 8) {\n        this.installError = 'Password must be at least 8 characters';\n        return;\n      }\n      \n      if (this.installForm.adminPassword !== this.installForm.confirmPassword) {\n        this.installError = 'Passwords do not match';\n        return;\n      }\n      \n      try {\n        const res = await this.api('POST', '/__15/__install', this.installForm);\n        if (res && res.success) {\n          this.isInstalled = true;\n          this.installError = '';\n          alert('Installation complete! Please login.');\n        } else {\n          this.installError = res?.message || 'Installation failed';\n        }\n      } catch (err) {\n        this.installError = 'Installation error: ' + err.message;\n      }\n    },\n    \n    login() {\n      if (!this.password) {\n        this.loginError = 'Please enter password';\n        return;\n      }\n      this.authHeader = 'Basic ' + btoa('admin:' + this.password);\n      localStorage.setItem('auth', this.authHeader);\n      this.loggedIn = true;\n      this.password = '';\n      this.loginError = '';\n      this.loadConfigs();\n      this.connectSocket();\n    },\n    \n    logout() {\n      localStorage.removeItem('auth');\n      this.loggedIn = false;\n      this.authHeader = '';\n      if (this.socket) {\n        this.socket.disconnect();\n        this.socket = null;\n      }\n    },\n    \n    async loadConfigs() {\n      const cfg = await this.api('GET', '/admin/pinggy-config');\n      if (cfg) {\n        this.pinggyJson = JSON.stringify(cfg, null, 2);\n      }\n      \n      const cronCfg = await this.api('GET', '/admin/cron-config');\n      if (cronCfg && cronCfg.interval) {\n        this.cronInterval = cronCfg.interval;\n      }\n      \n      const renderCfg = await this.api('GET', '/admin/render-url');\n      if (renderCfg && renderCfg.renderUrl !== undefined) {\n        this.renderUrl = renderCfg.renderUrl;\n      }\n    },\n    \n    async torStart() { \n      const res = await this.api('POST', '/admin/tor/start'); \n      if (!res) alert('Failed to start Tor');\n    },\n    \n    async torStop() { \n      await this.api('POST', '/admin/tor/stop'); \n    },\n    \n    async torRestart() { \n      await this.api('POST', '/admin/tor/restart'); \n    },\n    \n    async newCircuit() { \n      const res = await this.api('POST', '/admin/tor/newcircuit');\n      if (res && res.ok) {\n        alert('New circuit created successfully');\n      } else if (res && res.error) {\n        alert('Circuit change: ' + res.error);\n      }\n    },\n    \n    async pinggyStart() { \n      await this.api('POST', '/admin/pinggy/start'); \n    },\n    \n    async pinggyStop() { \n      await this.api('POST', '/admin/pinggy/stop'); \n    },\n    \n    async pinggyRestart() { \n      await this.api('POST', '/admin/pinggy/restart'); \n    },\n    \n    async wakeup() { \n      const res = await this.api('POST', '/admin/wakeup');\n      if (res && res.ok) {\n        alert('Wakeup request sent successfully!');\n      } else {\n        alert('Wakeup request failed. Check console for details.');\n      }\n    },\n    \n    async updateRenderUrl() {\n      const res = await this.api('POST', '/admin/render-url', { renderUrl: this.renderUrl });\n      if (res && res.ok) {\n        alert('Render URL updated successfully');\n      } else {\n        alert('Failed to update Render URL');\n      }\n    },\n    \n    async runMaintenance() { \n      await this.api('POST', '/admin/maintenance'); \n      alert('Maintenance routine executed');\n    },\n    \n    async updateCron() { \n      const res = await this.api('POST', '/admin/cron', { interval: this.cronInterval }); \n      if (res && res.ok) {\n        alert('Cron interval updated');\n      } else {\n        alert('Failed to update cron interval');\n      }\n    },\n    \n    async updatePinggy() {\n      try {\n        const cfg = JSON.parse(this.pinggyJson);\n        const res = await this.api('POST', '/admin/pinggy-config', cfg);\n        if (res && res.ok) {\n          this.configError = '';\n          alert('Configuration updated. Restarting Pinggy...');\n          await this.pinggyRestart();\n        } else {\n          this.configError = 'Failed to update configuration';\n        }\n      } catch(e) { \n        this.configError = 'Invalid JSON: ' + e.message;\n      }\n    },\n    \n    connectSocket() {\n      this.socket = io();\n      \n      this.socket.on('tor-status', s => {\n        this.torStatus = s;\n      });\n      \n      this.socket.on('tor-progress', p => {\n        this.torProgress = p;\n      });\n      \n      this.socket.on('pinggy-status', s => {\n        this.pinggyStatus = s;\n      });\n      \n      this.socket.on('pinggy-hostport', ({host, port}) => { \n        this.pinggyHost = host; \n        this.pinggyPort = port; \n      });\n      \n      this.socket.on('connect', () => {\n        console.log('Socket connected');\n      });\n      \n      this.socket.on('disconnect', () => {\n        console.log('Socket disconnected');\n      });\n    }\n  },\n  \n  mounted() {\n    if (this.isInstalled) {\n      const saved = localStorage.getItem('auth');\n      if (saved) { \n        this.authHeader = saved; \n        this.loggedIn = true; \n        this.loadConfigs(); \n        this.connectSocket();\n      }\n    }\n  }\n}).mount('#app');\n<\/script>\n</body>\n</html>`;r.get("/__15/__pcda",(n,t)=>t.send(c)),r.post("/__15/__install",async(r,a)=>{if(t)return a.status(400).json({success:!1,message:"Already installed"});const{adminPassword:i,confirmPassword:c,pinggyUsername:l,renderUrl:d}=r.body;if(!i||i.length<8)return a.status(400).json({success:!1,message:"Password must be at least 8 characters"});if(i!==c)return a.status(400).json({success:!1,message:"Passwords do not match"});try{const r=await bcrypt.hash(i,10);l&&l.trim()&&(o.username=l.trim()),void 0!==d&&(s=d.trim()),await n.set("adminPassword",r),await n.set("pinggyConfig",o),await n.set("renderUrl",s),await n.set("cronInterval","5m"),await n.set("installed",!0),e=r,t=!0,a.json({success:!0,message:"Installation complete"}),setTimeout(()=>u(),1e3)}catch(n){a.status(500).json({success:!1,message:n.message})}});const l=async(n,o,s)=>{if(!t)return o.status(403).json({error:"Not installed yet"});const r=n.headers.authorization;if(!r||!r.startsWith("Basic "))return o.status(401).json({error:"Unauthorized"});try{const[n,t]=Buffer.from(r.slice(6),"base64").toString().split(":");if("admin"!==n||!await bcrypt.compare(t,e))return o.status(401).json({error:"Unauthorized"});s()}catch(n){return o.status(401).json({error:"Unauthorized"})}};let d,g;r.get("/admin/pinggy-config",l,(n,t)=>{t.json(o)}),r.get("/admin/cron-config",l,(t,e)=>{e.json({interval:n.get("cronInterval")||"5m"})}),r.get("/admin/render-url",l,(t,e)=>{e.json({renderUrl:n.get("renderUrl")||""})}),r.post("/admin/render-url",l,async(t,e)=>{try{const{renderUrl:o}=t.body;s=o||"",await n.set("renderUrl",s),e.json({ok:!0})}catch(n){e.status(500).json({ok:!1,error:n.message})}}),r.post("/admin/tor/start",l,async(n,t)=>{try{await d.start(),t.json({ok:!0})}catch(n){t.status(500).json({ok:!1,error:n.message})}}),r.post("/admin/tor/stop",l,async(n,t)=>{try{await d.stop(),t.json({ok:!0})}catch(n){t.status(500).json({ok:!1,error:n.message})}}),r.post("/admin/tor/restart",l,async(n,t)=>{try{await d.restart(),t.json({ok:!0})}catch(n){t.status(500).json({ok:!1,error:n.message})}}),r.post("/admin/tor/newcircuit",l,async(n,t)=>{try{await d.newCircuit(),t.json({ok:!0})}catch(n){t.status(500).json({ok:!1,error:n.message})}}),r.post("/admin/pinggy/start",l,async(n,t)=>{try{await g.exec(),t.json({ok:!0})}catch(n){t.status(500).json({ok:!1,error:n.message})}}),r.post("/admin/pinggy/stop",l,async(n,t)=>{try{await g.stop(),t.json({ok:!0})}catch(n){t.status(500).json({ok:!1,error:n.message})}}),r.post("/admin/pinggy/restart",l,async(n,t)=>{try{await g.restart(),t.json({ok:!0})}catch(n){t.status(500).json({ok:!1,error:n.message})}}),r.post("/admin/pinggy-config",l,async(t,e)=>{try{o={...o,...t.body},await n.set("pinggyConfig",o),g.options={...g.options,...t.body},e.json({ok:!0})}catch(n){e.status(500).json({ok:!1,error:n.message})}}),r.post("/admin/wakeup",l,async(t,e)=>{try{const t=n.get("renderUrl")||"",o=d&&d.isReady();await wakeup(t,o),e.json({ok:!0})}catch(n){e.status(500).json({ok:!1,error:n.message})}}),r.post("/admin/maintenance",l,async(n,t)=>{try{await p(),t.json({ok:!0})}catch(n){t.status(500).json({ok:!1,error:n.message})}}),r.post("/admin/cron",l,async(t,e)=>{try{const{interval:o}=t.body;if(!o||!o.match(/\d+[mhs]/))return e.status(400).json({ok:!1,error:"Invalid interval format"});await n.set("cronInterval",o),globalStore.get("maintenanceInterval")&&clearInterval(globalStore.get("maintenanceInterval")),globalStore.set("maintenanceInterval",cron.schedule(o,p)),e.json({ok:!0})}catch(n){e.status(500).json({ok:!1,error:n.message})}}),r.use((n,t)=>t.redirect("/")),a.listen(8e3,()=>{console.log("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"),console.log("‚ïë  Tor + Pinggy Tunnel Manager          ‚ïë"),console.log("‚ïë  Server listening on port 8000        ‚ïë"),console.log("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")}),i.on("connection",n=>{console.log("Client connected"),n.emit("tor-status",d?d.isReady()?"Ready":"Stopped":"Unknown"),n.emit("tor-progress",d?d.getProgress():0),n.emit("pinggy-status",g?g.connected?"Connected":"Disconnected":"Unknown"),n.emit("pinggy-hostport",{host:globalStore.get("PINGGY_TCP_HOST")||"",port:globalStore.get("PINGGY_TCP_PORT")||""}),n.on("disconnect",()=>{console.log("Client disconnected")})});const p=async()=>{console.log("Running maintenance routine...");try{if(d&&d.isReady()){console.log("Creating new Tor circuit...");try{await d.newCircuit(),console.log("‚úì New circuit created")}catch(n){console.log("‚ö† Circuit change failed (may be rate limited):",n.message)}}if(g&&g.connected){console.log("Restarting Pinggy tunnel...");try{await g.restart(),console.log("‚úì Pinggy restarted")}catch(n){console.log("‚ö† Pinggy restart failed:",n.message)}}const t=n.get("renderUrl")||"",e=d&&d.isReady();console.log("Sending wakeup signal..."),await wakeup(t,e)}catch(n){console.error("Maintenance error:",n.message)}};async function u(){console.log("Starting services..."),d=new TorHelper({socksPort:9050,controlPort:9051,dataDir:"./tor-data"}),d.on("ready",()=>{console.log("‚úì Tor is ready"),i.emit("tor-status","Ready"),i.emit("tor-progress",100)}),d.on("exit",n=>{console.log(`Tor exited with code ${n||0}`),i.emit("tor-status","Stopped"),i.emit("tor-progress",0)}),d.on("progress",n=>{console.log(`Tor bootstrap: ${n}%`),i.emit("tor-progress",n)}),d.on("error",n=>{console.error("Tor error:",n.message)}),g=new SSHClientHelper(o),g.on("connect",(n,t)=>{console.log(`‚úì Pinggy tunnel connected: ${n}:${t}`),globalStore.set("PINGGY_TCP_HOST",n),globalStore.set("PINGGY_TCP_PORT",t),i.emit("pinggy-status","Connected"),i.emit("pinggy-hostport",{host:n,port:t})}),g.on("exit",()=>{console.log("Pinggy tunnel disconnected"),i.emit("pinggy-status","Disconnected")}),g.on("error",n=>{console.error("Pinggy error:",n.message)});const t=n.get("cronInterval")||"5m";console.log(`Setting up maintenance cron: ${t}`),globalStore.set("maintenanceInterval",cron.schedule(t,p));try{console.log("Starting Tor..."),await d.start(),console.log("Starting Pinggy tunnel..."),await g.exec()}catch(n){console.error("Failed to start services:",n.message)}}async function h(){try{globalStore.get("maintenanceInterval")&&clearInterval(globalStore.get("maintenanceInterval")),d&&(console.log("Stopping Tor..."),await d.stop()),g&&(console.log("Stopping Pinggy..."),await g.stop()),console.log("Shutdown complete"),process.exit(0)}catch(n){console.error("Error during shutdown:",n),process.exit(1)}}t&&await u(),process.on("SIGTERM",async()=>{console.log("Received SIGTERM, shutting down gracefully..."),await h()}),process.on("SIGINT",async()=>{console.log("Received SIGINT, shutting down gracefully..."),await h()})}main().catch(n=>{console.error("Fatal error:",n),process.exit(1)});
EOF

# Expose port
EXPOSE 8000

# Start the application
CMD ["node", "server.js"]
